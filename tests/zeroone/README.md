# ZeroOne

## テスト実行方法
```sh
PROC_TRACE_DIR=[root directory of proc-trace] make 
```

## PUT: zeroone

zerooneのソースコードはこのディレクトリにあるzeroone.cpp。

PUTの内容は、変数をa, b, ..., hの8個用意し、8文字の01文字列を受け付け、

 - 1番目の文字が'1'ならa=1, 1番目の文字が'0'ならa=0
 - 2番目の文字が'1'ならb=1, 2番目の文字が'0'ならb=0

 :

 - 8番目の文字が'1'ならh=1, 8番目の文字が'0'ならh=0

をやるだけ。

PUTソースコード中では
```asm
#define IFBRANCH(buf, idx, var) \
    __asm__ volatile ( \
        "   cmp %1, #0x31;" \
        "   b.eq 1f;" /* if bit is one, branch taken */ \
        "   mov %0, #0;" \
        "   b 2f;" \
        "1: mov %0, #1;" \
        "   b 2f;" \
        "2: nop;" /* dummy */ \
        : "=r" (var) \
        : "r" (buf[idx]) \
        : )
```
というマクロを定義し、これを
```c
    IFBRANCH(buf, 0, a);
    IFBRANCH(buf, 1, b);
    IFBRANCH(buf, 2, c);
    IFBRANCH(buf, 3, d);
    IFBRANCH(buf, 4, e);
    IFBRANCH(buf, 5, f);
    IFBRANCH(buf, 6, g);
    IFBRANCH(buf, 7, h);
```
という形で8回使っている。
これは、bufの1文字目から8文字目までの比較によるif分岐を8つユニークに作りたいという意図で記述している。
これによって、入力00000000, ..., 11111111の256通りに対して、256通りの異なるカバレッジが記録されるはず。これをテストする。

zerooneのmain関数は下記のようなコントロールグラフになっている。例えば、

 - 入力が00000000のとき、エッジカバレッジは `0x76c->0x79c->0x7ac->0x7c8->0x7d8->0x7f4 ...`
 - 入力が10000000のとき、エッジカバレッジは `0x76c->0x7a4->0x7ac->0x7c8->0x7d8->0x7f4 ...`

であるため、この2つの入力において、異なるエッジカバレッジは `0x76c->0x79c->0x7ac`と`0x76c->0x7a4->0x7ac` のみになる。

```
 ──────────────────────────────────────────────────────┐
│  0x76c                                               │
│   ; UNKNOWN XREF from section..rela.dyn @ +0x70      │
│ 444: int main (int argc, char **argv, int64_t envp); │
│ ; var int64_t var_0h_2 @ sp+0x0                      │
│ ; var int64_t var_10h @ sp+0x10                      │
│ ; var int64_t var_10h_2 @ sp+0x18                    │
│ ; var char **var_20h @ sp+0x20                       │
│ ; var int64_t var_0h @ sp+0x2c                       │
│ ; var int64_t var_38h @ sp+0x38                      │
│ ; var int64_t var_3ch @ sp+0x3c                      │
│ ; var int64_t var_40h @ sp+0x40                      │
│ ; var int64_t var_44h @ sp+0x44                      │
│ ; var int64_t var_48h @ sp+0x48                      │
│ ; var int64_t var_4ch @ sp+0x4c                      │
│ ; var int64_t var_50h @ sp+0x50                      │
│ ; var int64_t var_54h @ sp+0x54                      │
│ ; var int64_t var_58h @ sp+0x58                      │
│ ; arg int64_t envp @ sp+0xc0                         │
│ ; arg int argc @ x0                                  │
│ ; arg char **argv @ x1                               │
│ sub sp, sp, 0x60                                     │
│ stp x29, x30, [var_10h]                              │
│ add x29, var_10h                                     │
│ ; argc                                               │
│ str w0, [var_0h]                                     │
│ ; argv                                               │
│ str x1, [var_20h]                                    │
│ ; 0x5                                                │
│ ldr x0, [var_20h]                                    │
│ ; 0xd8                                               │
│ ldr x0, [x0, 8]                                      │
│ str x0, [var_58h]                                    │
│ ldr x0, [var_58h]                                    │
│ ; 0xd8                                               │
│ ldrb w0, [x0]                                        │
│ cmp x0, 0x31                                         │
│ b.eq 0x7a4                                           │
└──────────────────────────────────────────────────────┘
        f t
        │ │
        │ └─────────────────────┐
      ┌─┘                       │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x79c             │    │  0x7a4                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x798 │
  │ b 0x7ac            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x7ac                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───────┐                 │
              │ ┌───────────────┘
              │ │
        ┌───────────────────────────────────────┐
        │  0x7ac                                │
        │ ; CODE XREFS from main @ 0x7a0, 0x7a8 │
        │ nop                                   │
        │ str w0, [var_38h]                     │
        │ ldr x0, [var_58h]                     │
        │ add x0, x0, 1                         │
        │ ; 0xd8                                │
        │ ldrb w0, [x0]                         │
        │ cmp x0, 0x31                          │
        │ b.eq 0x7d0                            │
        └───────────────────────────────────────┘
                f t
                │ │
                │ └─────────────┐
      ┌─────────┘               │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x7c8             │    │  0x7d0                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x7c4 │
  │ b 0x7d8            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x7d8                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───────┐                 │
              │ ┌───────────────┘
              │ │
        ┌───────────────────────────────────────┐
        │  0x7d8                                │
        │ ; CODE XREFS from main @ 0x7cc, 0x7d4 │
        │ nop                                   │
        │ str w0, [var_3ch]                     │
        │ ldr x0, [var_58h]                     │
        │ add x0, x0, 2                         │
        │ ; 0xd8                                │
        │ ldrb w0, [x0]                         │
        │ cmp x0, 0x31                          │
        │ b.eq 0x7fc                            │
        └───────────────────────────────────────┘
                f t
                │ │
                │ └─────────────┐
      ┌─────────┘               │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x7f4             │    │  0x7fc                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x7f0 │
  │ b 0x804            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x804                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───────┐                 │
              │ ┌───────────────┘
              │ │
        ┌───────────────────────────────────────┐
        │  0x804                                │
        │ ; CODE XREFS from main @ 0x7f8, 0x800 │
        │ nop                                   │
        │ str w0, [var_40h]                     │
        │ ldr x0, [var_58h]                     │
        │ add x0, x0, 3                         │
        │ ; 0xd8                                │
        │ ldrb w0, [x0]                         │
        │ cmp x0, 0x31                          │
        │ b.eq 0x828                            │
        └───────────────────────────────────────┘
                f t
                │ │
                │ └─────────────┐
      ┌─────────┘               │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x820             │    │  0x828                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x81c │
  │ b 0x830            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x830                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───────┐                 │
              │ ┌───────────────┘
              │ │
        ┌───────────────────────────────────────┐
        │  0x830                                │
        │ ; CODE XREFS from main @ 0x824, 0x82c │
        │ nop                                   │
        │ str w0, [var_44h]                     │
        │ ldr x0, [var_58h]                     │
        │ ; aav.0x00000004                      │
        │ add x0, x0, 4                         │
        │ ; 0xd8                                │
        │ ldrb w0, [x0]                         │
        │ cmp x0, 0x31                          │
        │ b.eq 0x854                            │
        └───────────────────────────────────────┘
                f t
                │ │
                │ └─────────────┐
      ┌─────────┘               │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x84c             │    │  0x854                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x848 │
  │ b 0x85c            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x85c                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───────┐                 │
              │ ┌───────────────┘
              │ │
        ┌───────────────────────────────────────┐
        │  0x85c                                │
        │ ; CODE XREFS from main @ 0x850, 0x858 │
        │ nop                                   │
        │ str w0, [var_48h]                     │
        │ ldr x0, [var_58h]                     │
        │ add x0, x0, 5                         │
        │ ; 0xd8                                │
        │ ldrb w0, [x0]                         │
        │ cmp x0, 0x31                          │
        │ b.eq 0x880                            │
        └───────────────────────────────────────┘
                f t
                │ │
                │ └─────────────┐
      ┌─────────┘               │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x878             │    │  0x880                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x874 │
  │ b 0x888            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x888                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───────┐                 │
              │ ┌───────────────┘
              │ │
        ┌───────────────────────────────────────┐
        │  0x888                                │
        │ ; CODE XREFS from main @ 0x87c, 0x884 │
        │ nop                                   │
        │ str w0, [var_4ch]                     │
        │ ldr x0, [var_58h]                     │
        │ add x0, x0, 6                         │
        │ ; 0xd8                                │
        │ ldrb w0, [x0]                         │
        │ cmp x0, 0x31                          │
        │ b.eq 0x8ac                            │
        └───────────────────────────────────────┘
                f t
                │ │
                │ └─────────────┐
      ┌─────────┘               │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x8a4             │    │  0x8ac                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x8a0 │
  │ b 0x8b4            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x8b4                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───────┐                 │
              │ ┌───────────────┘
              │ │
        ┌───────────────────────────────────────┐
        │  0x8b4                                │
        │ ; CODE XREFS from main @ 0x8a8, 0x8b0 │
        │ nop                                   │
        │ str w0, [var_50h]                     │
        │ ldr x0, [var_58h]                     │
        │ add x0, x0, 7                         │
        │ ; 0xd8                                │
        │ ldrb w0, [x0]                         │
        │ cmp x0, 0x31                          │
        │ b.eq 0x8d8                            │
        └───────────────────────────────────────┘
                f t
                │ │
                │ └─────────────┐
      ┌─────────┘               │
      │                         │
  ┌────────────────────┐    ┌───────────────────────────────┐
  │  0x8d0             │    │  0x8d8                        │
  │ mov x0, 0          │    │ ; CODE XREF from main @ 0x8cc │
  │ b 0x8e0            │    │ mov x0, 1                     │
  └────────────────────┘    │ b 0x8e0                       │
      v                     └───────────────────────────────┘
      │                         v
      │                         │
      └───┐                     │
          │ ┌───────────────────┘
          │ │
    ┌───────────────────────────────────────────────┐
    │  0x8e0                                        │
    │ ; CODE XREFS from main @ 0x8d4, 0x8dc         │
    │ nop                                           │
    │ str w0, [var_54h]                             │
    │ ; 0x5                                         │
    │ ldr w1, [var_38h]                             │
    │ ; 0x5                                         │
    │ ldr w2, [var_3ch]                             │
    │ ; 0x5                                         │
    │ ldr w3, [var_40h]                             │
    │ ; 0x5                                         │
    │ ldr w4, [var_44h]                             │
    │ ldr w5, [var_48h]                             │
    │ ; 0x5                                         │
    │ ldr w6, [var_4ch]                             │
    │ ldr w7, [var_50h]                             │
    │ ldr w0, [var_54h]                             │
    │ str w0, [sp]                                  │
    │ adrp x0, 0                                    │
    │ ; const char *format                          │
    │ ; 0x9c8                                       │
    │ ; "Result: %d%d%d%d%d%d%d%d\n"                │
    │ add x0, x0, str.Result:__d_d_d_d_d_d_d_d_n    │
    │ ; int printf(const char *format)              │
    │ bl sym.imp.printf;[oa]                        │
    │ mov w0, 0                                     │
    │ ldp x29, x30, [var_10h]                       │
    │ ; 0x178000                                    │
    │ add sp, envp                                  │
    │ ret                                           │
    └───────────────────────────────────────────────┘
```

## テストでやっていること

まず、入力00000000で通るcoverageを記録する。
次に、10000000, 010000000, ..., 00000001の8つの入力で通るcoverageを記録する。
PUTは上記のような挙動をしているので、
例えば00000000と10000000のcoverageの差分というのは、
「0番目の文字によって、通るか通らないかが変化する箇所」のはず。

より具体的には、上記のPUTのコードでいうところの`IFBRANCH(buf, 0, a);`で生成される、
if分岐中の`a = 0;`の部分と`a = 1;`の部分が、それらに相当する。

よって、これらを全部記録しておく。

あとは、入力00000000 〜 11111111の256通りに対して、
記録したことをもとに正しいcoverageであるかどうかを判定する。

すべての入力のcoverageは、記録したものの"組み合わせ"によって表現できるはず。
たとえば、入力01010000のcoverageというのは、「すべての入力が通るBasic Block」に、
「入力01000000が通って、入力00000000が通らないBasic Block」と
「入力00010000が通って、入力00000000が通らないBasic Block」を
足し合わせたものになっていると考えられる。

逆に、確実に通らないBasic Blockも存在している。
例えば、「入力10000000が通って、入力00000000が通らないBasic Block」は、入力01010000のcoverageにおいて通っているはずがないし（1文字目が0なので）、
「入力00000000が通って、入力01000000が通らないBasic Block」も通るはずがない
（「入力01000000が通って、入力00000000が通らないBasic Block」を通っているため）。

これらについてすべてassertを掛けているのがテストコードの内容。
`struct DiffInfo`内に、前述の記録を追加していく。
メンバpassedには例えば「入力01000000が通って、入力00000000が通らないBasic Block」が入る。
メンバignoredには例えば「入力00000000が通って、入力01000000が通らないBasic Block」が入る。
これを10000000, 01000000, ..., 00000001の8つに対してやる。

あとは、passedとignoredを元に、256通りの入力に対してcoverageが通るべきBasic Blockを通っており、通らないべきBasic Blockを通っていないことを確認している。 
